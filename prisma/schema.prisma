generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Unit {
  code             String             @id // "g" | "kg" | "mL" | "L" | "piece" | "cac" | "cas"
  type             String // "mass" | "volume" | "count"
  ratioToBase      Float // ex: kg=1000 (vers g) ; L=1000 (vers mL) ; cac=5 ; cas=15

  // Nouvelles colonnes pour l'accord en genre et nombre
  singularForm     String? // forme au singulier (ex: "pièce", "tranche")
  pluralForm       String? // forme au pluriel (ex: "pièces", "tranches")
  gender           String? // "m" | "f" pour accord éventuel d'adjectifs

  RecipeIngredient RecipeIngredient[]
}

// Magasins personnalisables
model Store {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  order     Int      @default(0) // Pour trier l'ordre d'affichage
  createdAt DateTime @default(now())
}

// Compte utilisateur unique avec multi-devices
model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique
  passwordHash String // bcrypt hash
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  sessions     Session[]
  devices      Device[]
}

// Session d'authentification (durée 6 mois)
model Session {
  id        String   @id @default(cuid())
  userId    Int
  deviceId  Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  Device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// Appareil autorisé
model Device {
  id           Int       @id @default(autoincrement())
  userId       Int
  deviceName   String // ex: "iPhone de Damien", "iPad Cuisine"
  fingerprint  String    @unique // hash du user-agent + IP lors de la première connexion
  lastSeenAt   DateTime  @default(now())
  createdAt    DateTime  @default(now())

  User     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@index([fingerprint])
}

model Ingredient {
  id                 Int                  @id @default(autoincrement())
  nameNormalized     String               @unique
  canonicalUnit      String
  storeSection       String // primeur, crèmerie, etc.
  storeName          String? // nom du magasin (primeur "Chez Marcel", boulangerie "Paul", etc.)
  synonyms           Json // ex: ["zucchini","courgette verte"] (JSON au lieu de String[])
  RecipeIngredient   RecipeIngredient[]
  ShoppingListItem   ShoppingListItem[]
}

model Recipe {
  id              Int     @id @default(autoincrement())
  title           String
  slug            String  @unique
  description     String?
  imagePath       String?
  prepMin         Int?
  cookMin         Int?
  servingsDefault Int     @default(2)
  tags            Json // ex: ["dessert","vendredi"] (JSON au lieu de String[])

  steps       RecipeStep[]
  ingredients RecipeIngredient[]

  // relations opposées (retours) pour lever les erreurs
  mealPlanItems   MealPlanItem[]   @relation("RecipeMealPlanItems")
  recurrenceRules RecurrenceRule[] @relation("RecipeRecurrenceRules")
}

model RecipeStep {
  id       Int    @id @default(autoincrement())
  recipeId Int
  order    Int
  text     String
  Recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
}

model RecipeIngredient {
  id           Int     @id @default(autoincrement())
  recipeId     Int
  ingredientId Int
  qtyPerPerson Float // ex: 50 (g/personne)
  unitCode     String // doit correspondre à Unit.code
  note         String?

  Recipe     Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  Ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Restrict)
  Unit       Unit       @relation(fields: [unitCode], references: [code], onDelete: Restrict)
}

model MealPlan {
  id               Int                @id @default(autoincrement())
  date             DateTime // jour (UTC)
  slot             String // "midi" | "soir"
  peopleCount      Int
  items            MealPlanItem[]
  ShoppingListItem ShoppingListItem[]
}

model MealPlanItem {
  id         Int @id @default(autoincrement())
  mealPlanId Int
  recipeId   Int

  MealPlan MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  Recipe   Recipe   @relation("RecipeMealPlanItems", fields: [recipeId], references: [id], onDelete: Restrict)
}

model RecurrenceRule {
  id        Int       @id @default(autoincrement())
  recipeId  Int
  slot      String // "midi" | "soir"
  rruleText String // ex: FREQ=WEEKLY;BYDAY=FR
  startDate DateTime
  endDate   DateTime?

  Recipe Recipe @relation("RecipeRecurrenceRules", fields: [recipeId], references: [id], onDelete: Cascade)
}

// Liste de courses générée pour une période
model ShoppingList {
  id        Int                @id @default(autoincrement())
  startDate DateTime
  endDate   DateTime
  createdAt DateTime           @default(now())
  items     ShoppingListItem[]
}

// Un item de la liste de courses lié à un repas planifié spécifique
model ShoppingListItem {
  id             Int      @id @default(autoincrement())
  shoppingListId Int
  mealPlanId     Int // Le repas planifié d'où vient cet ingrédient
  ingredientId   Int
  quantity       Float
  unitCode       String
  purchased      Boolean  @default(false)
  purchasedAt    DateTime?

  ShoppingList ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  MealPlan     MealPlan     @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  Ingredient   Ingredient   @relation(fields: [ingredientId], references: [id], onDelete: Restrict)

  @@index([shoppingListId])
  @@index([mealPlanId])
}

// ───────────── Congélateur ─────────────

model Freezer {
  id        Int      @id @default(autoincrement())
  name      String // ex: "Congélateur cuisine", "Congélateur garage"
  order     Int      @default(0)
  drawers   Drawer[]
  createdAt DateTime @default(now())
}

model Drawer {
  id        Int           @id @default(autoincrement())
  name      String // ex: "Tiroir 1", "Tiroir haut"
  order     Int           @default(0)
  freezerId Int
  freezer   Freezer       @relation(fields: [freezerId], references: [id], onDelete: Cascade)
  items     FreezerItem[]
}

model FreezerItem {
  id             Int      @id @default(autoincrement())
  title          String
  type           String // "entree" | "plat" | "dessert" | "aliment_brut" | "plat_prepare"
  quantity       Int      @default(1)
  expirationDate DateTime
  drawerId       Int
  drawer         Drawer   @relation(fields: [drawerId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
